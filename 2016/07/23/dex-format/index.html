<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Dex," />





  <link rel="alternate" href="/atom.xml" title="任苹蜻的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="什么是dex文件他是Android系统的可执行文件，包含应用程序的全部操作指令以及运行时数据。
由于dalvik是一种针对嵌入式设备而特殊设计的java虚拟机，所以dex文件与标准的class文件在结构设计上有着本质的区别
当java程序编译成class后，还需要使用dx工具将所有的class文件整合到一个dex文件，目的是其中各个类能够共享数据，在一定程度上降低了冗余，同时也是文件结构更加经凑，">
<meta property="og:type" content="article">
<meta property="og:title" content="Dex文件格式">
<meta property="og:url" content="http://i.woblog.cn/2016/07/23/dex-format/index.html">
<meta property="og:site_name" content="任苹蜻的博客">
<meta property="og:description" content="什么是dex文件他是Android系统的可执行文件，包含应用程序的全部操作指令以及运行时数据。
由于dalvik是一种针对嵌入式设备而特殊设计的java虚拟机，所以dex文件与标准的class文件在结构设计上有着本质的区别
当java程序编译成class后，还需要使用dx工具将所有的class文件整合到一个dex文件，目的是其中各个类能够共享数据，在一定程度上降低了冗余，同时也是文件结构更加经凑，">
<meta property="og:image" content="http://i.stack.imgur.com/1kLrB.png">
<meta property="og:updated_time" content="2017-03-19T14:22:37.668Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dex文件格式">
<meta name="twitter:description" content="什么是dex文件他是Android系统的可执行文件，包含应用程序的全部操作指令以及运行时数据。
由于dalvik是一种针对嵌入式设备而特殊设计的java虚拟机，所以dex文件与标准的class文件在结构设计上有着本质的区别
当java程序编译成class后，还需要使用dx工具将所有的class文件整合到一个dex文件，目的是其中各个类能够共享数据，在一定程度上降低了冗余，同时也是文件结构更加经凑，">
<meta name="twitter:image" content="http://i.stack.imgur.com/1kLrB.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  <title> Dex文件格式 | 任苹蜻的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?48746acb55f702790215ece2fb3a3be5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">任苹蜻的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Dex文件格式
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-23T09:21:53+00:00" content="2016-07-23">
              2016-07-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Dalvik/" itemprop="url" rel="index">
                    <span itemprop="name">Dalvik</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/23/dex-format/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/23/dex-format/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="什么是dex文件"><a href="#什么是dex文件" class="headerlink" title="什么是dex文件"></a>什么是dex文件</h1><p>他是Android系统的可执行文件，包含应用程序的全部操作指令以及运行时数据。</p>
<p>由于dalvik是一种针对嵌入式设备而特殊设计的java虚拟机，所以dex文件与标准的class文件在结构设计上有着本质的区别</p>
<p>当java程序编译成class后，还需要使用dx工具将所有的class文件整合到一个dex文件，目的是其中各个类能够共享数据，在一定程度上降低了冗余，同时也是文件结构更加经凑，实验表明，dex文件是传统jar文件大小的50%左右</p>
<p><img src="http://i.stack.imgur.com/1kLrB.png" alt=""></p>
<p>可以看见：<br>dex将原来class每个文件都有的共有信息合成一体，这样减少了class的冗余</p>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><table>
<thead>
<tr>
<th style="text-align:center">类型</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">u1</td>
<td style="text-align:center">unit8_t,1字节无符号数</td>
</tr>
<tr>
<td style="text-align:center">u2</td>
<td style="text-align:center">unit16_t,2字节无符号数</td>
</tr>
<tr>
<td style="text-align:center">u4</td>
<td style="text-align:center">unit32_t,4字节无符号数</td>
</tr>
<tr>
<td style="text-align:center">u8</td>
<td style="text-align:center">unit64_t,8字节无符号数</td>
</tr>
<tr>
<td style="text-align:center">sleb128</td>
<td style="text-align:center">有符号LEB128,可变长度1~5</td>
</tr>
<tr>
<td style="text-align:center">uleb128</td>
<td style="text-align:center">无符号LEB128,</td>
</tr>
<tr>
<td style="text-align:center">uleb128p1</td>
<td style="text-align:center">无符号LEB128值加1，</td>
</tr>
</tbody>
</table>
<p>其中u1~u8很好理解,<a href="http://blog.csdn.net/zklth/article/details/7978362" target="_blank" rel="external">不理解的可以参考这里</a>，表示1到8个字节的无符号数，后面三个是dex特有的数据类型，更详细的参考：(深入到源码解析leb128数据类型)[<a href="http://i.woblog.cn/2016/07/23/leb128-format/">http://i.woblog.cn/2016/07/23/leb128-format/</a>]</p>
<h1 id="dex文件结构"><a href="#dex文件结构" class="headerlink" title="dex文件结构"></a>dex文件结构</h1><p>首先从宏观上来说dex的文件结果很简单，实际上是由多个不同结构的数据体以首尾相接的方式拼接而成。如下图：</p>
<table>
<thead>
<tr>
<th style="text-align:center">数据名称</th>
<th style="text-align:center">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">header</td>
<td style="text-align:center">dex文件头部，记录整个dex文件的相关属性</td>
</tr>
<tr>
<td style="text-align:center">string_ids</td>
<td style="text-align:center">字符串数据索引，记录了每个字符串在数据区的偏移量</td>
</tr>
<tr>
<td style="text-align:center">type_ids</td>
<td style="text-align:center">类似数据索引，记录了每个类型的字符串索引</td>
</tr>
<tr>
<td style="text-align:center">proto_ids</td>
<td style="text-align:center">原型数据索引，记录了方法声明的字符串，返回类型字符串，参数列表</td>
</tr>
<tr>
<td style="text-align:center">field_ids</td>
<td style="text-align:center">字段数据索引，记录了所属类，类型以及方法名</td>
</tr>
<tr>
<td style="text-align:center">method_ids</td>
<td style="text-align:center">类方法索引，记录方法所属类名，方法声明以及方法名等信息</td>
</tr>
<tr>
<td style="text-align:center">class_defs</td>
<td style="text-align:center">类定义数据索引，记录指定类各类信息，包括接口，超类，类数据偏移量</td>
</tr>
<tr>
<td style="text-align:center">data</td>
<td style="text-align:center">数据区，保存了各个类的真是数据</td>
</tr>
<tr>
<td style="text-align:center">link_data</td>
<td style="text-align:center">连接数据区</td>
</tr>
</tbody>
</table>
<p>/dalvik/libdex/DexFile.h</p>
<p>定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexFile &#123;</div><div class="line">    <span class="keyword">const</span> DexHeader*    pHeader;</div><div class="line">    <span class="keyword">const</span> DexStringId*  pStringIds;</div><div class="line">    <span class="keyword">const</span> DexTypeId*    pTypeIds;</div><div class="line">    <span class="keyword">const</span> DexFieldId*   pFieldIds;</div><div class="line">    <span class="keyword">const</span> DexMethodId*  pMethodIds;</div><div class="line">    <span class="keyword">const</span> DexProtoId*   pProtoIds;</div><div class="line">    <span class="keyword">const</span> DexClassDef*  pClassDefs;</div><div class="line">    <span class="keyword">const</span> DexLink*      pLinkData;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：其中一些定义的字段是在内存中并没有存到真是的dex文件中</p>
</blockquote>
<h1 id="header"><a href="#header" class="headerlink" title="header"></a>header</h1><p>简单记录了dex文件的一些基本信息，以及大致的数据分布。长度固定为0x70,其中每一项信息所占用的内存空间也是固定的，好处是虚拟机在处理dex时不用考虑dex文件的多样性</p>
<table>
<thead>
<tr>
<th style="text-align:center">字段名称</th>
<th style="text-align:center">偏移值</th>
<th style="text-align:center">长度</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">magic</td>
<td style="text-align:center">0x0</td>
<td style="text-align:center">8</td>
<td style="text-align:center">魔数字段，值为”dex\n035\0”</td>
</tr>
<tr>
<td style="text-align:center">checksum</td>
<td style="text-align:center">0x8</td>
<td style="text-align:center">4</td>
<td style="text-align:center">校验码</td>
</tr>
<tr>
<td style="text-align:center">signature</td>
<td style="text-align:center">0xc</td>
<td style="text-align:center">20</td>
<td style="text-align:center">sha-1签名</td>
</tr>
<tr>
<td style="text-align:center">file_size</td>
<td style="text-align:center">0x20</td>
<td style="text-align:center">4</td>
<td style="text-align:center">dex文件总长度</td>
</tr>
<tr>
<td style="text-align:center">header_size</td>
<td style="text-align:center">0x24</td>
<td style="text-align:center">4</td>
<td style="text-align:center">文件头长度，009版本=0x5c,035版本=0x70</td>
</tr>
<tr>
<td style="text-align:center">endian_tag</td>
<td style="text-align:center">0x28</td>
<td style="text-align:center">4</td>
<td style="text-align:center">标示字节顺序的常量</td>
</tr>
<tr>
<td style="text-align:center">link_size</td>
<td style="text-align:center">0x2c</td>
<td style="text-align:center">4</td>
<td style="text-align:center">链接段的大小，如果为0就是静态链接</td>
</tr>
<tr>
<td style="text-align:center">link_off</td>
<td style="text-align:center">0x30</td>
<td style="text-align:center">4</td>
<td style="text-align:center">链接段的开始位置</td>
</tr>
<tr>
<td style="text-align:center">map_off</td>
<td style="text-align:center">0x34</td>
<td style="text-align:center">4</td>
<td style="text-align:center">map数据基址</td>
</tr>
<tr>
<td style="text-align:center">string_ids_size</td>
<td style="text-align:center">0x38</td>
<td style="text-align:center">4</td>
<td style="text-align:center">字符串列表中字符串个数</td>
</tr>
<tr>
<td style="text-align:center">string_ids_off</td>
<td style="text-align:center">0x3c</td>
<td style="text-align:center">4</td>
<td style="text-align:center">字符串列表基址</td>
</tr>
<tr>
<td style="text-align:center">type_ids_size</td>
<td style="text-align:center">0x40</td>
<td style="text-align:center">4</td>
<td style="text-align:center">类列表里的类型个数</td>
</tr>
<tr>
<td style="text-align:center">type_ids_off</td>
<td style="text-align:center">0x44</td>
<td style="text-align:center">4</td>
<td style="text-align:center">类列表基址</td>
</tr>
<tr>
<td style="text-align:center">proto_ids_size</td>
<td style="text-align:center">0x48</td>
<td style="text-align:center">4</td>
<td style="text-align:center">原型列表里面的原型个数</td>
</tr>
<tr>
<td style="text-align:center">proto_ids_off</td>
<td style="text-align:center">0x4c</td>
<td style="text-align:center">4</td>
<td style="text-align:center">原型列表基址</td>
</tr>
<tr>
<td style="text-align:center">field_ids_size</td>
<td style="text-align:center">0x50</td>
<td style="text-align:center">4</td>
<td style="text-align:center">字段个数</td>
</tr>
<tr>
<td style="text-align:center">field_ids_off</td>
<td style="text-align:center">0x54</td>
<td style="text-align:center">4</td>
<td style="text-align:center">字段列表基址</td>
</tr>
<tr>
<td style="text-align:center">method_ids_size</td>
<td style="text-align:center">0x58</td>
<td style="text-align:center">4</td>
<td style="text-align:center">方法个数</td>
</tr>
<tr>
<td style="text-align:center">method_ids_off</td>
<td style="text-align:center">0x5c</td>
<td style="text-align:center">4</td>
<td style="text-align:center">方法列表基址</td>
</tr>
<tr>
<td style="text-align:center">class_defs_size</td>
<td style="text-align:center">0x60</td>
<td style="text-align:center">4</td>
<td style="text-align:center">类定义标中类的个数</td>
</tr>
<tr>
<td style="text-align:center">class_defs_off</td>
<td style="text-align:center">0x64</td>
<td style="text-align:center">4</td>
<td style="text-align:center">类定义列表基址</td>
</tr>
<tr>
<td style="text-align:center">data_size</td>
<td style="text-align:center">0x68</td>
<td style="text-align:center">4</td>
<td style="text-align:center">数据段的大小，必须4k对齐</td>
</tr>
<tr>
<td style="text-align:center">data_off</td>
<td style="text-align:center">0x6c</td>
<td style="text-align:center">4</td>
<td style="text-align:center">数据段基址</td>
</tr>
</tbody>
</table>
<p>/dalvik/libdex/DexFile.h</p>
<p>定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexHeader &#123;</div><div class="line">    u1  magic[<span class="number">8</span>];           <span class="comment">/* includes version number */</span></div><div class="line">    u4  checksum;           <span class="comment">/* adler32 checksum */</span></div><div class="line">    u1  signature[kSHA1DigestLen]; <span class="comment">/* SHA-1 hash */</span></div><div class="line">    u4  fileSize;           <span class="comment">/* length of entire file */</span></div><div class="line">    u4  headerSize;         <span class="comment">/* offset to start of next section */</span></div><div class="line">    u4  endianTag;</div><div class="line">    u4  linkSize;</div><div class="line">    u4  linkOff;</div><div class="line">    u4  mapOff;</div><div class="line">    u4  stringIdsSize;</div><div class="line">    u4  stringIdsOff;</div><div class="line">    u4  typeIdsSize;</div><div class="line">    u4  typeIdsOff;</div><div class="line">    u4  protoIdsSize;</div><div class="line">    u4  protoIdsOff;</div><div class="line">    u4  fieldIdsSize;</div><div class="line">    u4  fieldIdsOff;</div><div class="line">    u4  methodIdsSize;</div><div class="line">    u4  methodIdsOff;</div><div class="line">    u4  classDefsSize;</div><div class="line">    u4  classDefsOff;</div><div class="line">    u4  dataSize;</div><div class="line">    u4  dataOff;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>我们可以用：hexdump -c classes.dex查看dex单字节显示的结果，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">0000000   d   e   x  \n   0   3   5  \0 022 217   ?   w   z   ? 031 221</div><div class="line">0000010   ?  \f   ?   ?   ?   ?   ?   ? 217 235 200   z   ? 030   I   ?</div><div class="line">0000020   ? 003  \0  \0   p  \0  \0  \0   x   V   4 022  \0  \0  \0  \0</div><div class="line">0000030  \0  \0  \0  \0   ? 002  \0  \0 024  \0  \0  \0   p  \0  \0  \0</div><div class="line">0000040  \b  \0  \0  \0   ?  \0  \0  \0 005  \0  \0  \0   ?  \0  \0  \0</div><div class="line">0000050 001  \0  \0  \0 034 001  \0  \0 005  \0  \0  \0   $ 001  \0  \0</div><div class="line">0000060 001  \0  \0  \0   L 001  \0  \0   8 002  \0  \0   l 001  \0  \0</div><div class="line">0000070   l 001  \0  \0   t 001  \0  \0 201 001  \0  \0 204 001  \0  \0</div><div class="line">0000080 222 001  \0  \0 226 001  \0  \0   ? 001  \0  \0   ? 001  \0  \0</div><div class="line">0000090   ? 001  \0  \0   ? 001  \0  \0 004 002  \0  \0  \a 002  \0  \0</div><div class="line">00000a0  \v 002  \0  \0     002  \0  \0   ( 002  \0  \0   . 002  \0  \0</div><div class="line">00000b0   4 002  \0  \0   9 002  \0  \0   B 002  \0  \0   L 002  \0  \0</div><div class="line">00000c0 003  \0  \0  \0 005  \0  \0  \0 006  \0  \0  \0  \a  \0  \0  \0</div><div class="line">00000d0  \b  \0  \0  \0  \t  \0  \0  \0  \n  \0  \0  \0  \f  \0  \0  \0</div><div class="line">00000e0 002  \0  \0  \0 003  \0  \0  \0  \0  \0  \0  \0 004  \0  \0  \0</div><div class="line">00000f0 004  \0  \0  \0   x 002  \0  \0  \n  \0  \0  \0 006  \0  \0  \0</div><div class="line">0000100  \0  \0  \0  \0  \v  \0  \0  \0 006  \0  \0  \0   x 002  \0  \0</div><div class="line">0000110  \v  \0  \0  \0 006  \0  \0  \0   p 002  \0  \0 005  \0 001  \0</div><div class="line">0000120 020  \0  \0  \0  \0  \0 004  \0 017  \0  \0  \0 001  \0 003  \0</div><div class="line">0000130 021  \0  \0  \0 004  \0 002  \0  \0  \0  \0  \0 004  \0 001  \0</div><div class="line">0000140  \r  \0  \0  \0 004  \0  \0  \0 022  \0  \0  \0  \0  \0  \0  \0</div><div class="line">0000150 001  \0  \0  \0 002  \0  \0  \0  \0  \0  \0  \0   ?   ?   ?   ?</div><div class="line">0000160  \0  \0  \0  \0   ? 002  \0  \0  \0  \0  \0  \0 006   &lt;   i   n</div><div class="line">0000170   i   t   &gt;  \0  \v   H   e   l   l   o       W   o   r   l   d</div><div class="line">0000180  \0 001   L  \0  \f   L   H   e   l   l   o   W   o   r   l   d</div><div class="line">0000190   ;  \0 002   L   L  \0 025   L   j   a   v   a   /   i   o   /</div><div class="line">00001a0   P   r   i   n   t   S   t   r   e   a   m   ;  \0 022   L   j</div><div class="line">00001b0   a   v   a   /   l   a   n   g   /   O   b   j   e   c   t   ;</div><div class="line">00001c0  \0 022   L   j   a   v   a   /   l   a   n   g   /   S   t   r</div><div class="line">00001d0   i   n   g   ;  \0 031   L   j   a   v   a   /   l   a   n   g</div><div class="line">00001e0   /   S   t   r   i   n   g   B   u   i   l   d   e   r   ;  \0</div><div class="line">00001f0 022   L   j   a   v   a   /   l   a   n   g   /   S   y   s   t</div><div class="line">0000200   e   m   ;  \0 001   V  \0 002   V   L  \0 023   [   L   j   a</div><div class="line">0000210   v   a   /   l   a   n   g   /   S   t   r   i   n   g   ;  \0</div><div class="line">0000220 006   a   p   p   e   n   d  \0 004   a   r   g   s  \0 004   m</div><div class="line">0000230   a   i   n  \0 003   o   u   t  \0  \a   p   r   i   n   t   l</div><div class="line">0000240   n  \0  \b   t   o   S   t   r   i   n   g  \0 016   ?   ? 231</div><div class="line">0000250   ? 230   ?   ?   ? 200   ?   ?   ?   ? 211 213   ? 206 231   ?</div><div class="line">0000260 232 204   s   m   a   l   i   ?   ? 236   ?   ? 213  \0  \0  \0</div><div class="line">0000270 001  \0  \0  \0  \a  \0  \0  \0 001  \0  \0  \0 003  \0  \0  \0</div><div class="line">0000280  \0  \0  \0  \0  \0  \0  \0  \0  \0 001 017  \a  \0  \0  \0  \0</div><div class="line">0000290  \v  \0 001  \0 002  \0  \0  \0 210 002  \0  \0   (  \0  \0  \0</div><div class="line">00002a0   b  \0  \0  \0  \0  \0  \0  \0  \0  \0 022   2 023 003   ?   ?</div><div class="line">00002b0 030 004  \0  \0 001  \0  \0  \0  \0  \0 034 005 003  \0 001   &amp;</div><div class="line">00002c0   &quot;  \a 004  \0   p 020 002  \0  \a  \0 032  \b 023  \0   n    </div><div class="line">00002d0 003  \0 207  \0  \f  \a   n 020 004  \0  \a  \0  \f  \t   n    </div><div class="line">00002e0 001  \0 220  \0 032 001 001  \0   n     001  \0 020  \0 016  \0</div><div class="line">00002f0  \0  \0 001  \0  \0  \t 220 005 016  \0  \0  \0  \0  \0  \0  \0</div><div class="line">0000300 001  \0  \0  \0  \0  \0  \0  \0 001  \0  \0  \0 024  \0  \0  \0</div><div class="line">0000310   p  \0  \0  \0 002  \0  \0  \0  \b  \0  \0  \0   ?  \0  \0  \0</div><div class="line">0000320 003  \0  \0  \0 005  \0  \0  \0   ?  \0  \0  \0 004  \0  \0  \0</div><div class="line">0000330 001  \0  \0  \0 034 001  \0  \0 005  \0  \0  \0 005  \0  \0  \0</div><div class="line">0000340   $ 001  \0  \0 006  \0  \0  \0 001  \0  \0  \0   L 001  \0  \0</div><div class="line">0000350 002      \0  \0 024  \0  \0  \0   l 001  \0  \0 001 020  \0  \0</div><div class="line">0000360 002  \0  \0  \0   p 002  \0  \0 003 020  \0  \0 002  \0  \0  \0</div><div class="line">0000370 200 002  \0  \0 003      \0  \0 001  \0  \0  \0 210 002  \0  \0</div><div class="line">0000380 001      \0  \0 001  \0  \0  \0 220 002  \0  \0  \0      \0  \0</div><div class="line">0000390 001  \0  \0  \0   ? 002  \0  \0  \0 020  \0  \0 001  \0  \0  \0</div><div class="line">00003a0   ? 002  \0  \0                                                </div><div class="line">00003a4</div></pre></td></tr></table></figure>
<p>我们还可以用-C显示16进制和ASCII码</p>
<p>hexdump -C classes.dex</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">00000000  64 65 78 0a 30 33 35 00  12 8f b1 77 7a e9 19 91  |dex.035....wz...|</div><div class="line">00000010  f2 0c ff ce a0 ce aa cd  8f 9d 80 7a ac 18 49 bf  |...........z..I.|</div><div class="line">00000020  a4 03 00 00 70 00 00 00  78 56 34 12 00 00 00 00  |....p...xV4.....|</div><div class="line">00000030  00 00 00 00 f8 02 00 00  14 00 00 00 70 00 00 00  |............p...|</div><div class="line">00000040  08 00 00 00 c0 00 00 00  05 00 00 00 e0 00 00 00  |................|</div><div class="line">00000050  01 00 00 00 1c 01 00 00  05 00 00 00 24 01 00 00  |............$...|</div><div class="line">00000060  01 00 00 00 4c 01 00 00  38 02 00 00 6c 01 00 00  |....L...8...l...|</div><div class="line">00000070  6c 01 00 00 74 01 00 00  81 01 00 00 84 01 00 00  |l...t...........|</div><div class="line">00000080  92 01 00 00 96 01 00 00  ad 01 00 00 c1 01 00 00  |................|</div><div class="line">00000090  d5 01 00 00 f0 01 00 00  04 02 00 00 07 02 00 00  |................|</div><div class="line">000000a0  0b 02 00 00 20 02 00 00  28 02 00 00 2e 02 00 00  |.... ...(.......|</div><div class="line">000000b0  34 02 00 00 39 02 00 00  42 02 00 00 4c 02 00 00  |4...9...B...L...|</div><div class="line">000000c0  03 00 00 00 05 00 00 00  06 00 00 00 07 00 00 00  |................|</div><div class="line">000000d0  08 00 00 00 09 00 00 00  0a 00 00 00 0c 00 00 00  |................|</div><div class="line">000000e0  02 00 00 00 03 00 00 00  00 00 00 00 04 00 00 00  |................|</div><div class="line">000000f0  04 00 00 00 78 02 00 00  0a 00 00 00 06 00 00 00  |....x...........|</div><div class="line">00000100  00 00 00 00 0b 00 00 00  06 00 00 00 78 02 00 00  |............x...|</div><div class="line">00000110  0b 00 00 00 06 00 00 00  70 02 00 00 05 00 01 00  |........p.......|</div><div class="line">00000120  10 00 00 00 00 00 04 00  0f 00 00 00 01 00 03 00  |................|</div><div class="line">00000130  11 00 00 00 04 00 02 00  00 00 00 00 04 00 01 00  |................|</div><div class="line">00000140  0d 00 00 00 04 00 00 00  12 00 00 00 00 00 00 00  |................|</div><div class="line">00000150  01 00 00 00 02 00 00 00  00 00 00 00 ff ff ff ff  |................|</div><div class="line">00000160  00 00 00 00 f0 02 00 00  00 00 00 00 06 3c 69 6e  |.............&lt;in|</div><div class="line">00000170  69 74 3e 00 0b 48 65 6c  6c 6f 20 57 6f 72 6c 64  |it&gt;..Hello World|</div><div class="line">00000180  00 01 4c 00 0c 4c 48 65  6c 6c 6f 57 6f 72 6c 64  |..L..LHelloWorld|</div><div class="line">00000190  3b 00 02 4c 4c 00 15 4c  6a 61 76 61 2f 69 6f 2f  |;..LL..Ljava/io/|</div><div class="line">000001a0  50 72 69 6e 74 53 74 72  65 61 6d 3b 00 12 4c 6a  |PrintStream;..Lj|</div><div class="line">000001b0  61 76 61 2f 6c 61 6e 67  2f 4f 62 6a 65 63 74 3b  |ava/lang/Object;|</div><div class="line">000001c0  00 12 4c 6a 61 76 61 2f  6c 61 6e 67 2f 53 74 72  |..Ljava/lang/Str|</div><div class="line">000001d0  69 6e 67 3b 00 19 4c 6a  61 76 61 2f 6c 61 6e 67  |ing;..Ljava/lang|</div><div class="line">000001e0  2f 53 74 72 69 6e 67 42  75 69 6c 64 65 72 3b 00  |/StringBuilder;.|</div><div class="line">000001f0  12 4c 6a 61 76 61 2f 6c  61 6e 67 2f 53 79 73 74  |.Ljava/lang/Syst|</div><div class="line">00000200  65 6d 3b 00 01 56 00 02  56 4c 00 13 5b 4c 6a 61  |em;..V..VL..[Lja|</div><div class="line">00000210  76 61 2f 6c 61 6e 67 2f  53 74 72 69 6e 67 3b 00  |va/lang/String;.|</div><div class="line">00000220  06 61 70 70 65 6e 64 00  04 61 72 67 73 00 04 6d  |.append..args..m|</div><div class="line">00000230  61 69 6e 00 03 6f 75 74  00 07 70 72 69 6e 74 6c  |ain..out..printl|</div><div class="line">00000240  6e 00 08 74 6f 53 74 72  69 6e 67 00 0e e8 bf 99  |n..toString.....|</div><div class="line">00000250  e6 98 af e4 b8 80 e4 b8  aa e6 89 8b e5 86 99 e7  |................|</div><div class="line">00000260  9a 84 73 6d 61 6c 69 e5  ae 9e e4 be 8b 00 00 00  |..smali.........|</div><div class="line">00000270  01 00 00 00 07 00 00 00  01 00 00 00 03 00 00 00  |................|</div><div class="line">00000280  00 00 00 00 00 00 00 00  00 01 0f 07 00 00 00 00  |................|</div><div class="line">00000290  0b 00 01 00 02 00 00 00  88 02 00 00 28 00 00 00  |............(...|</div><div class="line">000002a0  62 00 00 00 00 00 00 00  00 00 12 32 13 03 ff ff  |b..........2....|</div><div class="line">000002b0  18 04 00 00 01 00 00 00  00 00 1c 05 03 00 01 26  |...............&amp;|</div><div class="line">000002c0  22 07 04 00 70 10 02 00  07 00 1a 08 13 00 6e 20  |&quot;...p.........n |</div><div class="line">000002d0  03 00 87 00 0c 07 6e 10  04 00 07 00 0c 09 6e 20  |......n.......n |</div><div class="line">000002e0  01 00 90 00 1a 01 01 00  6e 20 01 00 10 00 0e 00  |........n ......|</div><div class="line">000002f0  00 00 01 00 00 09 90 05  0e 00 00 00 00 00 00 00  |................|</div><div class="line">00000300  01 00 00 00 00 00 00 00  01 00 00 00 14 00 00 00  |................|</div><div class="line">00000310  70 00 00 00 02 00 00 00  08 00 00 00 c0 00 00 00  |p...............|</div><div class="line">00000320  03 00 00 00 05 00 00 00  e0 00 00 00 04 00 00 00  |................|</div><div class="line">00000330  01 00 00 00 1c 01 00 00  05 00 00 00 05 00 00 00  |................|</div><div class="line">00000340  24 01 00 00 06 00 00 00  01 00 00 00 4c 01 00 00  |$...........L...|</div><div class="line">00000350  02 20 00 00 14 00 00 00  6c 01 00 00 01 10 00 00  |. ......l.......|</div><div class="line">00000360  02 00 00 00 70 02 00 00  03 10 00 00 02 00 00 00  |....p...........|</div><div class="line">00000370  80 02 00 00 03 20 00 00  01 00 00 00 88 02 00 00  |..... ..........|</div><div class="line">00000380  01 20 00 00 01 00 00 00  90 02 00 00 00 20 00 00  |. ........... ..|</div><div class="line">00000390  01 00 00 00 f0 02 00 00  00 10 00 00 01 00 00 00  |................|</div><div class="line">000003a0  f8 02 00 00                                       |....|</div><div class="line">000003a4</div></pre></td></tr></table></figure>
<h2 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h2><p>标识一个有效的dex文件，他的固定值为：64 65 78 0a 30 33 35 00，转换为字符串为dex.035.<br>在电子取证中也称“文件签名”</p>
<h2 id="checksum"><a href="#checksum" class="headerlink" title="checksum"></a>checksum</h2><p>他是整个头部的校验和。它被用来校验头部是否损坏</p>
<h2 id="signature"><a href="#signature" class="headerlink" title="signature"></a>signature</h2><h2 id="file-size"><a href="#file-size" class="headerlink" title="file_size"></a>file_size</h2><p>记录包括dexHeader在内的整个dex文件大小，用来计算偏移和方便定位某区段(section),他也有诸如唯一的标识dex,因为他是dex文件中计算sha-1区段的一个组成部分</p>
<h2 id="header-size"><a href="#header-size" class="headerlink" title="header_size"></a>header_size</h2><p>存放整个DexHeadeer结构体的长度，它也可用来计算下一个区段在文件中的起始位置，目前值为0x70</p>
<h2 id="endian-tag"><a href="#endian-tag" class="headerlink" title="endian_tag"></a>endian_tag</h2><p>指定dex运行环境的CPU字节序，存放的是一个固定值，所有dex文件都一样的，值为：78 56 34 12,0x12345678,表示默认采用little-endian字节序</p>
<h2 id="link-size"><a href="#link-size" class="headerlink" title="link_size"></a>link_size</h2><h2 id="link-off"><a href="#link-off" class="headerlink" title="link_off"></a>link_off</h2><p>当多个class文件被编译到一个dex文件是，他们会用到link_size和link_off，通常为0</p>
<p>可以看到上面的，link_off：为00 00 00 00</p>
<h2 id="map-off"><a href="#map-off" class="headerlink" title="map_off"></a>map_off</h2><p>他指定了dexMapList结构的文件偏移量</p>
<h2 id="string-ids-size"><a href="#string-ids-size" class="headerlink" title="string_ids_size"></a>string_ids_size</h2><p>是指string存放区段的大小，用来计算string区段起始位置-相对于dex文件加载基地址的偏移量</p>
<p>string_ids_off存放string区段的实际偏移量，单位字节。他可以帮助编译器和虚拟机直接跳到这个区段，而不必从前读到后，一直读取到该位置。<br>type,prototype,method,class,data id的大小(size)和偏移量(offset)和string的作用一样</p>
<p>每个字符串都对应一个DexStringId数据结构，大小为4B,同时虚拟机可以通过头文件中的string_ids_size知道当前dex文件中字符串的总数，也就是string_ids区域中DexStringId数据结构的总数，所以虚拟机可以通过简单的乘法运算即可实现对字符串资源的索引，也可以根据kDexTypeStringIdItem获取字符串</p>
<p>我们举个例子来根据header里面的字符串信息索引字符串，还是以上面的classes.dex文件来分析：</p>
<p>根据stringIdsSize找到有多少个DexStringId（也就是有多少个字符串）:</p>
<p>0x38：0x14,说明有20个字符串</p>
<p>根据stringIdsOff查看DexStringId的偏移量:</p>
<p>0x3c：0x70,说明DexStringId的开始位置在0x70</p>
<p>读取4个字节：6c 01 00 00，转为地址为0x16c，这就是第一个字符串的位置<br>在读取4个字节：74 01 00 00，0x174</p>
<p>分别获取这个两个位置的字符串：</p>
<p>06 3c 69 6e 69 74 3e 00:值为<code>&lt;init&gt;\0</code>,其中06表示后面有6个字符(不包括\0)<br>0b 48 65 6c 6c 6f 20 57 6f 72 6c 64:值为Hello World\0,0b表示有11个字符</p>
<p>我们发现每个字符串是使用“\0”分割的</p>
<p>首先他的开始位置0x70,我们根据stringIdsSize的值得知接下来有20个字符，首先我们计算DexStringId的地址截止到:0x70+0x14(20)*4=0xc0(不包括0xc0)</p>
<p>先获取DexStringId，然后在获取地址位置的值</p>
<table>
<thead>
<tr>
<th>DexStringId偏移</th>
<th>String偏移</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x70</td>
<td>0x16c</td>
<td><code>&lt;init&gt;</code></td>
</tr>
<tr>
<td>74</td>
<td>174</td>
<td>Hello World</td>
</tr>
<tr>
<td>78</td>
<td>181</td>
<td>L</td>
</tr>
<tr>
<td>7c</td>
<td>184</td>
<td>LHelloWorld;</td>
</tr>
<tr>
<td>80</td>
<td>192</td>
<td>LL</td>
</tr>
<tr>
<td>84</td>
<td>196</td>
<td>Ljava/io/PrintStream;</td>
</tr>
<tr>
<td>88</td>
<td>1ad</td>
<td>Ljava/lang/Object;</td>
</tr>
<tr>
<td>8c</td>
<td>1c1</td>
<td>Ljava/lang/String;</td>
</tr>
<tr>
<td>90</td>
<td>1d5</td>
<td>Ljava/lang/StringBuilder;</td>
</tr>
<tr>
<td>94</td>
<td>1f0</td>
<td>Ljava/lang/System;</td>
</tr>
<tr>
<td>98</td>
<td>204</td>
<td>V</td>
</tr>
<tr>
<td>9c</td>
<td>207</td>
<td>VL</td>
</tr>
<tr>
<td>a0</td>
<td>20b</td>
<td>[Ljava/lang/String;</td>
</tr>
<tr>
<td>a4</td>
<td>220</td>
<td>append</td>
</tr>
<tr>
<td>a8</td>
<td>228</td>
<td>args</td>
</tr>
<tr>
<td>ac</td>
<td>22e</td>
<td>main</td>
</tr>
<tr>
<td>b0</td>
<td>234</td>
<td>out</td>
</tr>
<tr>
<td>b4</td>
<td>239</td>
<td>println</td>
</tr>
<tr>
<td>b8</td>
<td>242</td>
<td>toString</td>
</tr>
<tr>
<td>bc</td>
<td>24c</td>
</tr>
</tbody>
</table>
<p>上面的字符串并非普通的ASCII字符串，他们是由MUTF-8编码来表示的，<a href="http://i.woblog.cn/2016/07/25/mutf-8/">更详细的介绍参考这篇文章</a></p>
<h1 id="dex文件结构分析"><a href="#dex文件结构分析" class="headerlink" title="dex文件结构分析"></a>dex文件结构分析</h1><p>我们采用前面的classes.dex文件作为演示对象</p>
<p>dalvik虚拟机解析dex文件的内容，最终将其映射成DexMapList数据结构，DexHeader中的mapOff字段指定了DexMapList结构在dex在文件中的偏移，他的申明如下：</p>
<p>/dalvik/libdex/DexFile.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexMapList &#123;</div><div class="line">    u4  size;               <span class="comment">/* 个数 */</span></div><div class="line">    DexMapItem <span class="built_in">list</span>[<span class="number">1</span>];     <span class="comment">/* DexMapItem的结构 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中size字段表示dex接来下有多少个DexMapItem结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexMapItem &#123;</div><div class="line">    u2 type;              <span class="comment">/* kDexType开头的类型 */</span></div><div class="line">    u2 unused;            <span class="comment">/*未使用，用于字节对齐 */</span></div><div class="line">    u4 size;              <span class="comment">/* 类型的个数 */</span></div><div class="line">    u4 offset;            <span class="comment">/* 类型的文件偏移 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>type字段为一个枚举常量，可以通过类型名称很容易判断他的具体类型：</p>
<p>DexFile.h(6.0.1)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    kDexTypeHeaderItem               = <span class="number">0x0000</span>,</div><div class="line">    kDexTypeStringIdItem             = <span class="number">0x0001</span>,</div><div class="line">    kDexTypeTypeIdItem               = <span class="number">0x0002</span>,</div><div class="line">    kDexTypeProtoIdItem              = <span class="number">0x0003</span>,</div><div class="line">    kDexTypeFieldIdItem              = <span class="number">0x0004</span>,</div><div class="line">    kDexTypeMethodIdItem             = <span class="number">0x0005</span>,</div><div class="line">    kDexTypeClassDefItem             = <span class="number">0x0006</span>,</div><div class="line">    kDexTypeMapList                  = <span class="number">0x1000</span>,</div><div class="line">    kDexTypeTypeList                 = <span class="number">0x1001</span>,</div><div class="line">    kDexTypeAnnotationSetRefList     = <span class="number">0x1002</span>,</div><div class="line">    kDexTypeAnnotationSetItem        = <span class="number">0x1003</span>,</div><div class="line">    kDexTypeClassDataItem            = <span class="number">0x2000</span>,</div><div class="line">    kDexTypeCodeItem                 = <span class="number">0x2001</span>,</div><div class="line">    kDexTypeStringDataItem           = <span class="number">0x2002</span>,</div><div class="line">    kDexTypeDebugInfoItem            = <span class="number">0x2003</span>,</div><div class="line">    kDexTypeAnnotationItem           = <span class="number">0x2004</span>,</div><div class="line">    kDexTypeEncodedArrayItem         = <span class="number">0x2005</span>,</div><div class="line">    kDexTypeAnnotationsDirectoryItem = <span class="number">0x2006</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>这里我们以上面的clsses.dex来分析，DexHeader结构的mapOff字段为f8 02 00 00，根据小端序，他的值为0x2f8,读取出的双字值为0e 00 00 00（0x0e）,表示接下来有14个DexMapItem结构,接着在读取0x2fc值为：0x00表示这个DexMapItem类型是kDexTypeHeaderItem，在读取0x2fe值为：0x00这个字段没有使用。在读取0x300值为：01 00 00 00表示有一个，在0x304读取:00 00 00 00表示偏移为0x0</p>
<p>根据上面的规则我们整理除了14个Item</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>个数</th>
<th>偏移</th>
</tr>
</thead>
<tbody>
<tr>
<td>kDexTypeHeaderItem</td>
<td>0x1</td>
<td>0x0</td>
</tr>
<tr>
<td>kDexTypeStringIdItem</td>
<td>0x14</td>
<td>0x70</td>
</tr>
<tr>
<td>kDexTypeTypeIdItem</td>
<td>0x8</td>
<td>0xc0</td>
</tr>
<tr>
<td>kDexTypeProtoIdItem</td>
<td>0x5</td>
<td>0xe0</td>
</tr>
<tr>
<td>kDexTypeFieldIdItem</td>
<td>0x1</td>
<td>0x11c</td>
</tr>
<tr>
<td>kDexTypeMethodIdItem</td>
<td>0x5</td>
<td>0x124</td>
</tr>
<tr>
<td>kDexTypeClassDefItem</td>
<td>0x1</td>
<td>0x14c</td>
</tr>
<tr>
<td>kDexTypeStringDataItem</td>
<td>0x14</td>
<td>0x16c</td>
</tr>
<tr>
<td>kDexTypeTypeList</td>
<td>0x2</td>
<td>0x270</td>
</tr>
<tr>
<td>kDexTypeAnnotationSetItem</td>
<td>0x2</td>
<td>0x280</td>
</tr>
<tr>
<td>kDexTypeDebugsssInfoItem</td>
<td>0x1</td>
<td>0x288</td>
</tr>
<tr>
<td>kDexTypeCodeItem</td>
<td>0x1</td>
<td>0x290</td>
</tr>
<tr>
<td>kDexTypeClassDataItem</td>
<td>0x1</td>
<td>0x2f0</td>
</tr>
<tr>
<td>kDexTypeMapList</td>
<td>0x1</td>
<td>0x2f8</td>
</tr>
</tbody>
</table>
<p>对比文件我们发下DexHeader就是kDexTypeHeaderItem描述的结构，他占用了文件前0x70个字节空间，接下来的kDexTypeStringIdItem~kDexTypeClassDefItem与DexHeader中对应字段值是一样的</p>
<h2 id="kDexTypeStringIdItem"><a href="#kDexTypeStringIdItem" class="headerlink" title="kDexTypeStringIdItem"></a>kDexTypeStringIdItem</h2><p>对应DexHeader中的stringIdsSize与stringIdsOff字段，表示从0x70位置起有连续0x14个DexStringId:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexStringId &#123;</div><div class="line">    u4 stringDataOff;      <span class="comment">/* file offset to string_data_item */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>他只有一个stringDataOff字段，指向字符串数据的偏移位置，开始地址为0x70+(14*4)=0xc0,所以我们最后一个dexStringId的偏移为：0xbc，我们根据此信息整理了所以字符串:</p>
<table>
<thead>
<tr>
<th>dexStringId偏移</th>
<th>真实字符串偏移</th>
<th>字符串</th>
<th>索引</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x70</td>
<td>0x16c</td>
<td><code>&lt;init&gt;</code></td>
<td>0x0</td>
</tr>
<tr>
<td>74</td>
<td>174</td>
<td>Hello World</td>
<td>1</td>
</tr>
<tr>
<td>78</td>
<td>181</td>
<td>L</td>
<td>2</td>
</tr>
<tr>
<td>7c</td>
<td>184</td>
<td>LHelloWorld;</td>
<td>3</td>
</tr>
<tr>
<td>80</td>
<td>192</td>
<td>LL</td>
<td>4</td>
</tr>
<tr>
<td>84</td>
<td>196</td>
<td>Ljava/io/PrintStream;</td>
<td>5</td>
</tr>
<tr>
<td>88</td>
<td>1ad</td>
<td>Ljava/lang/Object;</td>
<td>6</td>
</tr>
<tr>
<td>8c</td>
<td>1c1</td>
<td>Ljava/lang/String;</td>
<td>7</td>
</tr>
<tr>
<td>90</td>
<td>1d5</td>
<td>Ljava/lang/StringBuilder;</td>
<td>8</td>
</tr>
<tr>
<td>94</td>
<td>1f0</td>
<td>Ljava/lang/System;</td>
<td>9</td>
</tr>
<tr>
<td>98</td>
<td>204</td>
<td>V</td>
<td>a</td>
</tr>
<tr>
<td>9c</td>
<td>207</td>
<td>VL</td>
<td>b</td>
</tr>
<tr>
<td>a0</td>
<td>20b</td>
<td>[Ljava/lang/String;</td>
<td>c</td>
</tr>
<tr>
<td>a4</td>
<td>220</td>
<td>append</td>
<td>d</td>
</tr>
<tr>
<td>a8</td>
<td>282</td>
<td>args</td>
<td>e</td>
</tr>
<tr>
<td>ac</td>
<td>22e</td>
<td>main</td>
<td>f</td>
</tr>
<tr>
<td>b0</td>
<td>234</td>
<td>out</td>
<td>10</td>
</tr>
<tr>
<td>b4</td>
<td>239</td>
<td>println</td>
<td>11</td>
</tr>
<tr>
<td>b8</td>
<td>242</td>
<td>toString</td>
<td>12</td>
</tr>
<tr>
<td>bc</td>
<td>24c</td>
<td>这是一个手写的smali实例</td>
<td>13</td>
</tr>
</tbody>
</table>
<h2 id="kDexTypeTypeIdItem"><a href="#kDexTypeTypeIdItem" class="headerlink" title="kDexTypeTypeIdItem"></a>kDexTypeTypeIdItem</h2><p>他对应DexHeader中的typeIdsSize和typeIdsOff字段，指向的结构体为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexTypeId &#123;</div><div class="line">    u4  descriptorIdx;      <span class="comment">/* 指向DexStringId列表的索引 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>对应的字符串代表具体的类型，我们根据上面字段可知：从0xc0起有0x8个DexTypeId结构：</p>
<table>
<thead>
<tr>
<th style="text-align:left">类型索引</th>
<th>字符串索引</th>
<th>字符串</th>
<th>DexTypeId偏移</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td>0x3</td>
<td>LHelloWorld;</td>
<td>0xc0</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td>0x5</td>
<td>Ljava/io/PrintStream;</td>
<td>0xc4</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td>0x6</td>
<td>Ljava/lang/Object;</td>
<td>0xc8</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td>0x7</td>
<td>Ljava/lang/String;</td>
<td>0xcc</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td>0x8</td>
<td>Ljava/lang/StringBuilder;</td>
<td>0xd0</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td>0x9</td>
<td>Ljava/lang/System;</td>
<td>0xd4</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td>0xa</td>
<td>L</td>
<td>0xd8</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td>0xc</td>
<td>[Ljava/lang/String;</td>
<td>0xdc</td>
</tr>
</tbody>
</table>
<h2 id="kDexTypeProtoIdItem"><a href="#kDexTypeProtoIdItem" class="headerlink" title="kDexTypeProtoIdItem"></a>kDexTypeProtoIdItem</h2><p>对应DexHeader中的protoIdsSize与protoIdsOff字段，声明如果：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexProtoId &#123;</div><div class="line">    u4  shortyIdx;          <span class="comment">/* 指向DexStringId列表的索引 */</span></div><div class="line">    u4  returnTypeIdx;      <span class="comment">/* 指向DexTypeId列表的索引 */</span></div><div class="line">    u4  parametersOff;      <span class="comment">/* 指向DexTypeList的偏移 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>他是一个方法的声明结构体，shortyIdx为方法声明字符串，returnTypeIdx为方法返回类型字符串，parametersOff指向一个DexTypeList的结构体存放了方法的参数列表</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span>  &#123;</div><div class="line">    u4  size;               <span class="comment">/* 接下来DexTypeItem的个数 */</span></div><div class="line">    DexTypeItem <span class="built_in">list</span>[<span class="number">1</span>];    <span class="comment">/* DexTypeItem结构 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>DexTypeItem声明：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexTypeItem &#123;</div><div class="line">    u2  typeIdx;            <span class="comment">/* 指向DexTypeId列表的索引 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>根据上面的信息我们得知从0xe0开始有0x5个DexProtoId对象</p>
<table>
<thead>
<tr>
<th>索引</th>
<th>方法声明</th>
<th>返回类型</th>
<th>参数列表</th>
<th>paramOff偏移</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>L</td>
<td>Ljava/lang/String;</td>
<td>无参数</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>LL</td>
<td>Ljava/lang/StringBuilder;</td>
<td>Ljava/lang/String;</td>
<td>0x278</td>
</tr>
<tr>
<td>2</td>
<td>V</td>
<td>L</td>
<td>无参数</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>VL</td>
<td>L</td>
<td>Ljava/lang/String;</td>
<td>0x278</td>
</tr>
<tr>
<td>4</td>
<td>VL</td>
<td>L</td>
<td>[Ljava/lang/String;</td>
<td>0x270</td>
</tr>
</tbody>
</table>
<h2 id="kDexTypeFieldIdItem"><a href="#kDexTypeFieldIdItem" class="headerlink" title="kDexTypeFieldIdItem"></a>kDexTypeFieldIdItem</h2><p>对应DexHeader中的fieldIdsSize和fieldIdsOff字段，指向DexFieldId结构体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexFieldId &#123;</div><div class="line">    u2  classIdx;           <span class="comment">/* 类的类型，指向DexTypeId列表索引 */</span></div><div class="line">    u2  typeIdx;            <span class="comment">/* 字段类型，指向DexTypeId列表索引 */</span></div><div class="line">    u4  nameIdx;            <span class="comment">/* 字段名，指向DexStringId列表 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>可以看见这个结构的数据全部是索引信息，指明了字段所在的类，字段类型，字段名，通过上面的信息我们发现从0x11c有一个kDexTypeFieldIdItem</p>
<table>
<thead>
<tr>
<th>类类型</th>
<th>字段类型</th>
<th>字段名</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ljava/lang/System;</td>
<td>Ljava/io/PrintStream;</td>
<td>out</td>
</tr>
</tbody>
</table>
<h2 id="kDexTypeMethodIdItem"><a href="#kDexTypeMethodIdItem" class="headerlink" title="kDexTypeMethodIdItem"></a>kDexTypeMethodIdItem</h2><p>它对应DexHeader中的methodIdsSize与methodIdsOff字段，指向的结构体DexMethodId</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexMethodId &#123;</div><div class="line">    u2  classIdx;           <span class="comment">/* 类的类型，指向DexTypeId列表的索引 */</span></div><div class="line">    u2  protoIdx;           <span class="comment">/* 声明类型，指向DexProtoId列表索引 */</span></div><div class="line">    u4  nameIdx;            <span class="comment">/* 方法名，指向DexStringId列表的索引 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>数据也是索引，指明了方法所在的类，方法声明和方法名。从0x124有0x5个kDexTypeMethodIdItem</p>
<table>
<thead>
<tr>
<th>类类型</th>
<th>方法声明</th>
<th>方法名</th>
</tr>
</thead>
<tbody>
<tr>
<td>LHelloWorld;</td>
<td>VL</td>
<td>main</td>
</tr>
<tr>
<td>Ljava/io/PrintStream;</td>
<td>VL</td>
<td>println</td>
</tr>
<tr>
<td>Ljava/lang/StringBuilder;</td>
<td>V</td>
<td><code>&lt;init&gt;</code></td>
</tr>
<tr>
<td>Ljava/lang/StringBuilder;</td>
<td>LL</td>
<td>append</td>
</tr>
<tr>
<td>Ljava/lang/StringBuilder;</td>
<td>L</td>
<td>toString</td>
</tr>
</tbody>
</table>
<h2 id="kDexTypeClassDefItem"><a href="#kDexTypeClassDefItem" class="headerlink" title="kDexTypeClassDefItem"></a>kDexTypeClassDefItem</h2><p>对应DexHeader中的classDefsSize和classDefsOff字段，指向结构体DexClassDef</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexClassDef &#123;</div><div class="line">    u4  classIdx;           <span class="comment">/* 类的类型，指向DexTypeId列表索引 */</span></div><div class="line">    u4  accessFlags;        <span class="comment">/* 访问标志 */</span></div><div class="line">    u4  superclassIdx;      <span class="comment">/* 父类的类型，指向DexTypeId列表的索引 */</span></div><div class="line">    u4  interfacesOff;      <span class="comment">/* 实现了哪些接口，指向DexTypeList结构的偏移 */</span></div><div class="line">    u4  sourceFileIdx;      <span class="comment">/* 源文件名，指向DexStringId列表的索引 */</span></div><div class="line">    u4  annotationsOff;     <span class="comment">/* 注解，指向DexAnnotationsDirectoryItem结构的偏移 */</span></div><div class="line">    u4  classDataOff;       <span class="comment">/* 指向DexClassData结构的偏移 */</span></div><div class="line">    u4  staticValuesOff;    <span class="comment">/* 指向DexEncodedArray结构的偏移 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>classIdx是一个索引值，表示类的类型</p>
<p>accessFlags是类的访问标志，他是以ACC_开头的枚举值</p>
<p>superclassIdx是父类的类型</p>
<p>interfacesOff如果类含有接口声明或实现，他就会指向一个DexTypeList结构，否则为0</p>
<p>sourceFileIdx是类所在源文件名称</p>
<p>annotationsOff字段指向注解目录结构，根据类型不同有注解类，注解方法，注解字段，注解参数。如果没有注解，值为0</p>
<p>classDataOff指向DexClassData结构，是类的数据部分</p>
<p>staticValuesOff记录了类中的静态数据</p>
<h3 id="DexClassData"><a href="#DexClassData" class="headerlink" title="DexClassData"></a>DexClassData</h3><p>声明在DexClass.h中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexClassData &#123;</div><div class="line">    DexClassDataHeader header; <span class="comment">//指向DexClassDataHeader，字段和方法个数</span></div><div class="line">    DexField*          staticFields; <span class="comment">//静态字段</span></div><div class="line">    DexField*          instanceFields; <span class="comment">//实例字段</span></div><div class="line">    DexMethod*         directMethods; <span class="comment">//直接方法</span></div><div class="line">    DexMethod*         virtualMethods;<span class="comment">//虚方法</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="DexClassDataHeader"><a href="#DexClassDataHeader" class="headerlink" title="DexClassDataHeader"></a>DexClassDataHeader</h4><p>记录了当前类中的字段和方法的数目，声明如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexClassDataHeader &#123;</div><div class="line">    u4 staticFieldsSize; <span class="comment">//静态字段个数</span></div><div class="line">    u4 instanceFieldsSize;<span class="comment">//实例字段个数</span></div><div class="line">    u4 directMethodsSize;<span class="comment">//直接方法个数</span></div><div class="line">    u4 virtualMethodsSize;<span class="comment">//虚方法个数</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="DexField"><a href="#DexField" class="headerlink" title="DexField"></a>DexField</h4><p>描述了字段类型与访问标志，声明如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexField &#123;</div><div class="line">    u4 fieldIdx;    <span class="comment">/* 指向DexFieldId列表的索引 */</span></div><div class="line">    u4 accessFlags; <span class="comment">//访问标志</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="DexMethod"><a href="#DexMethod" class="headerlink" title="DexMethod"></a>DexMethod</h4><p>描述了方法的原型，名称，访问标志和代码数据块，声明如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexMethod &#123;</div><div class="line">    u4 methodIdx;    <span class="comment">/* 指向DexMethodId列表的索引 */</span></div><div class="line">    u4 accessFlags;</div><div class="line">    u4 codeOff;      <span class="comment">/* 指向DexCode结构的偏移 */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>codeOff字段指向一个DexCode结构体，声明如下：</p>
<p>/dalvik/libdex/DexFile.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> DexCode &#123;</div><div class="line">    u2  registersSize;<span class="comment">//使用寄存器个数</span></div><div class="line">    u2  insSize;<span class="comment">//参数个数</span></div><div class="line">    u2  outsSize;<span class="comment">//调用其他方法时使用的寄存器个数</span></div><div class="line">    u2  triesSize;<span class="comment">//try/catch个数</span></div><div class="line">    u4  debugInfoOff;<span class="comment">//指向调试信息的偏移</span></div><div class="line">    u4  insnsSize;<span class="comment">//指令集个数，以2字节为单位</span></div><div class="line">    u2  insns[<span class="number">1</span>];<span class="comment">//指令集</span></div><div class="line">    <span class="comment">/* followed by optional u2 padding */</span></div><div class="line">    <span class="comment">/* followed by try_item[triesSize] */</span></div><div class="line">    <span class="comment">/* followed by uleb handlersSize */</span></div><div class="line">    <span class="comment">/* followed by catch_handler_item[handlersSize] */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>registersSize指令了方法使用的寄存器个数，对应smali中的.locals 2</p>
<p>insSize指定了方法的参数个数，对应.param p1, “noteId”    # Ljava/lang/String;</p>
<p>如果一个方法使用5个寄存器，其中2有两个参数寄存器，而该方法调用另一个方法使用了20个寄存器，那么虚拟机在分配该方法寄存器是会在分配20个寄存器</p>
<p>triesSize指定了方法中Try/Catch格式</p>
<p>debugInfoOff指向调试信息偏移，如果有，解析函数为dexDecodoDebugInfo在DexDebugInfo.cpp文件</p>
<p>insnsSize接下来指令个数</p>
<p>insns真正的代码部分</p>
<p>根据上面的信息，我们发现从0x14c有0x1个kDexTypeClassDefItem：</p>
<p>第一个字段值为0x0,表示对应DexType中的索引为0，值为LHelloWorld;，表示类名为HelloWorld</p>
<p>第二个字段值为0x1表示访问标识符为ACC_PUBLIC</p>
<p>第三个字段值0x2表示父类，表示指向DexType的索引，值为Ljava/lang/Object;，表示父类为java/lang/Object;</p>
<p>第四个字段值0x0,表示没有接口</p>
<p>第五个字段值</p>
<p>第六个字段值0x0表示没有注解</p>
<p>第七个字段值0x2f0表示DexClassData的偏移</p>
<p>第八个字段值0x0表示没有静态值</p>
<p>我们继续分析DexClassData</p>
<p>DexClassDataHeader为4个uleb128数据类型，从0x2f0开始值为：0，0，1，0，表示静态字段为0个，实例字段为0个，1个直接方法，0个虚方法</p>
<p>由于没有静态字段，实例字段，虚方法，所以我们直接分析DexMethod</p>
<p>从0x2f4开始为一个直接方法相关数据，第一个字段为0，指向的DexMethod列表第0个，也就是main方法。第二个值09，表示public+static，具体的看下面表：</p>
<p>现在来说下accessFlags在字节码中的计算方式：<br>access_flags的计算公式为：access_flags = flagA | flagB | flagB …</p>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>public</td>
</tr>
<tr>
<td>ACC_PRIVATE</td>
<td>0x0002</td>
<td>private</td>
</tr>
<tr>
<td>ACC_PROTECTED</td>
<td>0x0004</td>
<td>protected</td>
</tr>
<tr>
<td>ACC_STATIC</td>
<td>0x0008</td>
<td>static</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>final</td>
</tr>
<tr>
<td>ACC_VOLATILE</td>
<td>0x0040</td>
<td>volatile</td>
</tr>
<tr>
<td>ACC_TRANSIENT</td>
<td>0x0080</td>
<td>transient</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>是否是编译器自动生成的</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>enum</td>
</tr>
</tbody>
</table>
<p>第三个字段为90 05，值为0x290，我们从0x290开始分析DexCode，值为：</p>
<p>0b 00=11</p>
<p>01 00=1</p>
<p>02 00=2</p>
<p>00 00=0</p>
<p>表示使用了11个寄存器，1个参数寄存器，调用其他方法使用了2个寄存器，没有Try/Catch</p>
<p>88 02 00 00=0x288,debugInfoOff</p>
<p>28 00 00 00=0x28,insnsSize，指令个数，以2字节为单位</p>
<p>我们先读取一个两个字节6200，查看<a href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode.html" target="_blank" rel="external">dalvik bytecode</a>发现为sget-object,指令格式为21c,查询<a href="https://source.android.com/devices/tech/dalvik/instruction-formats.html" target="_blank" rel="external">instruction formats</a>可以看到指令格式为：</p>
<p>AA|op BBBB</p>
<p>可以看出他需要两个16位，21C对应有以下几种格式：</p>
<table>
<thead>
<tr>
<th>op vAA, type@BBBB</th>
<th>check-cast</th>
</tr>
</thead>
<tbody>
<tr>
<td>op vAA, field@BBBB</td>
<td>const-class</td>
</tr>
<tr>
<td>op vAA, string@BBBB</td>
<td>const-string</td>
</tr>
</tbody>
</table>
<p>由于我们的指令是sget，所有这条指令格式为op vAA, field@BBBB</p>
<p>在读取两个字节0000，表示在字段索引0，所以这条指令为</p>
<p>sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</p>
<p>继续从0x2a4分析：</p>
<p>00 00，查看bytecode为10x,在查询指令格式为：</p>
<p>ØØ|op    10x    op，可以看出只需要两个字节，所以这条指令为：nop</p>
<p>00 00：nop</p>
<p>00 00：nop</p>
<p>12 32:op=12,A=2,B=3查询字节码代码格式，const/4 vA, #+B，格式为11n，最终翻译为：const/4 v2, 0x3</p>
<p>13 03：op=13,const/16 vAA, #+BBBB,格式21s，格式为AA|op BBBB，所以需要两个字节，在读取两个字节，ff ff，最终指令格式为：const/16 v3, -0x1</p>
<p>剩下的指令可以按照上面的步骤翻译完</p>
<p>18 04：</p>
<p>const-wide vAA, #+BBBBBBBBBBBBBBBB</p>
<p>AA|op<br>BBBBlo BBBB BBBB BBBBhi</p>
<p>0000 0100 0000 0000<br>每两位调换位置：<br>0000 0010 0000 0000<br>从低位到高位排列<br>0000 0000 0010 0000</p>
<p>最后这条指令为：</p>
<p>const-wide v4, 0x100000</p>

      
    </div>
    
    <div>
      
        
<div id="wechat_subscriber" style="display: block； padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/wechat-qcode.jpg" alt="任苹蜻 wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div>
</div>

      
    </div>

    <div>
      
        
<div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton", disable="enable", onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}", style="cursor: pointer; border: 0; outline: 0; border-radius: 100%; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0px; text-shadow: none">
    <span onmouseover="this.style.color='rgb(236,96,0)';this.style.background='rgb(204,204,204)'" onMouseOut="this.style.color='#fff';this.style.background='rgb(236,96,0)'" style="display: inline-block; width: 70px; height: 70px; border-radius: 100%; line-height: 81px; color: #fff; font: 400 35px/75px 'microsofty'; background: rgb(236,96,0)">赏</span>
  </button>
  <div id="QR" style="display: none;">
    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/wechat-reward-image.png" alt="任苹蜻 WeChat Pay" style="width: 200px; max-width: 100%; display: inline-block"/>
        <p>微信打赏</p>
      </div>
    
    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/uploads/alipay-reward-image.png" alt="任苹蜻 Alipay" style="width: 200px; max-width: 100%; display: inline-block"/>
        <p>支付宝打赏</p>
      </div>
    
  </div>
</div>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Dex/" rel="tag">#Dex</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/18/android-gradle-start/" rel="next" title="Android Gradle入门教程">
                <i class="fa fa-chevron-left"></i> Android Gradle入门教程
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/23/leb128-format/" rel="prev" title="深入到源码解析leb128数据类型">
                深入到源码解析leb128数据类型 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/07/23/dex-format/"
     data-title="Dex文件格式"
     data-content=""
     data-url="http://i.woblog.cn/2016/07/23/dex-format/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/07/23/dex-format/"
           data-title="Dex文件格式" data-url="http://i.woblog.cn/2016/07/23/dex-format/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://tp4.sinaimg.cn/1662907603/180/5755316418/1"
               alt="任苹蜻" />
          <p class="site-author-name" itemprop="name">任苹蜻</p>
          <p class="site-description motion-element" itemprop="description">关注移动开发，大数据，云计算，软件架构（原博客：http://me.woblog.cn/）</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">86</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/renpingqing1993" target="_blank" title="Weibo">
                  
                    <i class="fa fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/lifengsofts/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/2cb78e578e43/latest_articles" target="_blank" title="Jianshu">
                  
                    <i class="fa fa-Jianshu"></i>
                  
                  Jianshu
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element">
            <div class="links-of-blogroll-title">Links</div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://example.com/" title="Title" target="_blank">Title</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#什么是dex文件"><span class="nav-number">1.</span> <span class="nav-text">什么是dex文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据结构"><span class="nav-number">2.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dex文件结构"><span class="nav-number">3.</span> <span class="nav-text">dex文件结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#header"><span class="nav-number">4.</span> <span class="nav-text">header</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#magic"><span class="nav-number">4.1.</span> <span class="nav-text">magic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#checksum"><span class="nav-number">4.2.</span> <span class="nav-text">checksum</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#signature"><span class="nav-number">4.3.</span> <span class="nav-text">signature</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#file-size"><span class="nav-number">4.4.</span> <span class="nav-text">file_size</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#header-size"><span class="nav-number">4.5.</span> <span class="nav-text">header_size</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#endian-tag"><span class="nav-number">4.6.</span> <span class="nav-text">endian_tag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#link-size"><span class="nav-number">4.7.</span> <span class="nav-text">link_size</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#link-off"><span class="nav-number">4.8.</span> <span class="nav-text">link_off</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#map-off"><span class="nav-number">4.9.</span> <span class="nav-text">map_off</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#string-ids-size"><span class="nav-number">4.10.</span> <span class="nav-text">string_ids_size</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dex文件结构分析"><span class="nav-number">5.</span> <span class="nav-text">dex文件结构分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kDexTypeStringIdItem"><span class="nav-number">5.1.</span> <span class="nav-text">kDexTypeStringIdItem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kDexTypeTypeIdItem"><span class="nav-number">5.2.</span> <span class="nav-text">kDexTypeTypeIdItem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kDexTypeProtoIdItem"><span class="nav-number">5.3.</span> <span class="nav-text">kDexTypeProtoIdItem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kDexTypeFieldIdItem"><span class="nav-number">5.4.</span> <span class="nav-text">kDexTypeFieldIdItem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kDexTypeMethodIdItem"><span class="nav-number">5.5.</span> <span class="nav-text">kDexTypeMethodIdItem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kDexTypeClassDefItem"><span class="nav-number">5.6.</span> <span class="nav-text">kDexTypeClassDefItem</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DexClassData"><span class="nav-number">5.6.1.</span> <span class="nav-text">DexClassData</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DexClassDataHeader"><span class="nav-number">5.6.1.1.</span> <span class="nav-text">DexClassDataHeader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DexField"><span class="nav-number">5.6.1.2.</span> <span class="nav-text">DexField</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DexMethod"><span class="nav-number">5.6.1.3.</span> <span class="nav-text">DexMethod</span></a></li></ol></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">任苹蜻</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"iwoblog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
